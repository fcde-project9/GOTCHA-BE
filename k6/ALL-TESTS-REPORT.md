# GOTCHA Backend 전체 테스트 리포트

**테스트 일시**: 2026-02-05
**테스트 환경**: AWS EC2 t3.small
**테스트 도구**: k6
**대상 서버**: http://13.209.53.103:8080

---

## 1. 테스트 실행 요약

### 1.1 단일 API 테스트 (Light - VU 10명)

| 테스트 | 요청 수 | 평균 | p(95) | 에러율 | 상태 |
|--------|---------|------|-------|--------|------|
| shop-map.js | 287 | 23.48ms | 43.59ms | 0% | ✅ 정상 |
| shop-detail.js | 275 | 67.04ms | 171.00ms | 0% | ✅ 정상 |
| shop-search.js | 284 | 20.59ms | 41.29ms | 100% | ❌ 실패 |
| review-list.js | 286 | 28.45ms | 43.50ms | 0% | ✅ 정상 |
| all-apis.js | 179 | 27.14ms | 52.15ms | 15.64% | ⚠️ 부분 실패 |

### 1.2 통합 부하 테스트

| 부하 | VU | 시간 | 요청 수 | 평균 | p(95) | RPS | 에러율 |
|------|-----|------|---------|------|-------|-----|--------|
| Light | 10 | 50초 | 618 | 32.32ms | 87.54ms | 12 | 0% |
| Medium | 50 | 2분 | 6,124 | 71.26ms | 276.00ms | 51 | 0% |
| Heavy | 200 | 5분 | 51,068 | 53.91ms | 174.22ms | 169 | 0% |
| Spike | 200 | 1분 | 7,990 | 39.74ms | 101.37ms | 114 | 0% |

### 1.3 동시성 충돌 테스트

| 메트릭 | 값 | 평가 |
|--------|-----|------|
| 총 요청 수 | 3,052 | - |
| 성공률 | 43.58% | ⚠️ 낮음 |
| Race Condition 감지 | 1,545회 | ⚠️ 문제 발견 |
| 중복 생성 | 0회 | ✅ DB 제약조건 정상 |
| 정상 충돌 처리 (409) | 944회 | ✅ 정상 |

---

## 2. API별 상세 분석

### 2.1 Shop Map API (지도 조회)
```
GET /api/shops/map
```

| 메트릭 | Light (10 VU) | Spike (200 VU) |
|--------|---------------|----------------|
| 요청 수 | 287 | 7,990 |
| 평균 | 23.48ms | 39.74ms |
| p(95) | 43.59ms | 101.37ms |
| 에러율 | 0% | 0% |

**평가**: ✅ 매우 우수
- 200 VU 스파이크에서도 p(95) < 200ms
- 에러 없이 안정적

---

### 2.2 Shop Detail API (가게 상세)
```
GET /api/shops/{id}
```

| 메트릭 | Light (10 VU) |
|--------|---------------|
| 요청 수 | 275 |
| 평균 | 67.04ms |
| p(95) | 171.00ms |
| 에러율 | 0% |

**평가**: ✅ 양호
- 다른 API 대비 상대적으로 느림
- 더 많은 데이터를 조회하기 때문에 예상 범위 내

**개선 포인트**:
- N+1 쿼리 확인 필요
- 불필요한 JOIN 최적화 검토

---

### 2.3 Shop Search API (가게 검색)
```
GET /api/shops/search
```

| 메트릭 | Light (10 VU) |
|--------|---------------|
| 요청 수 | 284 |
| 평균 | 20.59ms |
| p(95) | 41.29ms |
| 에러율 | **100%** |

**평가**: ❌ 실패
- 모든 요청이 실패
- API 스펙 또는 요청 파라미터 확인 필요

**조치 필요**:
1. 검색 API 엔드포인트 확인
2. 필수 파라미터 확인
3. k6 스크립트 수정

---

### 2.4 Review List API (리뷰 목록)
```
GET /api/shops/{id}/reviews
```

| 메트릭 | Light (10 VU) |
|--------|---------------|
| 요청 수 | 286 |
| 평균 | 28.45ms |
| p(95) | 43.50ms |
| 에러율 | 0% |

**평가**: ✅ 매우 우수
- 빠른 응답 시간
- 안정적

---

### 2.5 All APIs (전체 API 통합)
```
API 비율: 지도(40%) | 상세(25%) | 검색(15%) | 리뷰(10%) | 내정보(5%) | 찜(5%)
```

| 메트릭 | Light (10 VU) |
|--------|---------------|
| 요청 수 | 179 |
| 평균 | 27.14ms |
| p(95) | 52.15ms |
| 에러율 | 15.64% |

**평가**: ⚠️ 부분 실패
- 에러율 15.64%는 검색 API(15%) 실패로 인한 것
- 검색 API 제외 시 정상

---

## 3. 성능 순위

### 3.1 응답 시간 순위 (Light 기준)

| 순위 | API | 평균 | p(95) |
|------|-----|------|-------|
| 1 | 검색 | 20.59ms | 41.29ms |
| 2 | 지도 조회 | 23.48ms | 43.59ms |
| 3 | 리뷰 목록 | 28.45ms | 43.50ms |
| 4 | 가게 상세 | 67.04ms | 171.00ms |

### 3.2 안정성 순위

| 순위 | API | 에러율 |
|------|-----|--------|
| 1 | 지도 조회 | 0% |
| 1 | 가게 상세 | 0% |
| 1 | 리뷰 목록 | 0% |
| 4 | 검색 | 100% |

---

## 4. 발견된 문제점

### 4.1 검색 API 오류 (심각도: 높음)

**증상**: 모든 검색 요청이 실패 (에러율 100%)

**API 직접 테스트 결과**:
```bash
$ curl "http://13.209.53.103:8080/api/shops/search?keyword=가챠"

# 응답
{
  "success": false,
  "error": {
    "code": "SERVER_001",
    "message": "서버 내부 오류가 발생했습니다"
  }
}
```

**원인**: 서버 내부 오류 (SERVER_001)
- 검색 로직에 버그 존재
- DB 쿼리 오류 또는 NullPointerException 가능성

**조치 필요**:
1. 서버 로그 확인 (`/var/log/` 또는 CloudWatch)
2. ShopController.search() 메서드 디버깅
3. 검색 쿼리 직접 실행 테스트

---

### 4.2 Race Condition (심각도: 중간)

**증상**: 동시성 테스트에서 1,545회 500 에러 발생

**원인**: Check-Then-Act 패턴
```java
// 문제 코드
if (repository.findBy...().isPresent()) {
    throw Exception();  // 여기서 통과 후
}
repository.save();  // 중복 저장 시도 → 500 에러
```

**해결 방안**:
```java
// 권장 해결책
try {
    repository.save(entity);
} catch (DataIntegrityViolationException e) {
    throw CustomException.alreadyExists();  // 409 반환
}
```

---

### 4.3 가게 상세 API 느림 (심각도: 낮음)

**증상**: 다른 API 대비 2-3배 느림

**원인 추정**:
- 복잡한 JOIN 쿼리
- N+1 문제 가능성

**권장 조치**:
- 쿼리 로그 분석
- Fetch Join 적용 검토

---

## 5. 결론

### 5.1 전체 평가

| 항목 | 평가 | 설명 |
|------|------|------|
| 처리량 | ✅ 우수 | 169 RPS, 분당 10,000건+ |
| 응답 시간 | ✅ 우수 | 대부분 API p(95) < 200ms |
| 안정성 | ⚠️ 개선 필요 | 검색 API 오류, Race Condition |
| 확장성 | ✅ 우수 | 200 VU에서도 안정적 |

### 5.2 우선 조치 사항

| 우선순위 | 작업 | 영향도 |
|---------|------|--------|
| 1 | 검색 API 오류 수정 | 높음 |
| 2 | 동시성 처리 개선 (500→409) | 중간 |
| 3 | 가게 상세 API 최적화 | 낮음 |

### 5.3 서버 상태

**t3.small 인스턴스에서 프로덕션 트래픽 감당 가능**

| 메트릭 | 값 |
|--------|-----|
| 최대 동시 접속자 | 200명 |
| 최대 RPS | 169 req/s |
| 예상 일일 처리량 | 1,000만+ 요청 |

---

## 6. 테스트 실행 명령어

```bash
# 단일 API 테스트
k6 run -e BASE_URL=http://13.209.53.103:8080 k6/scripts/shop-map.js
k6 run -e BASE_URL=http://13.209.53.103:8080 -e TEST_SHOP_ID=2 k6/scripts/shop-detail.js
k6 run -e BASE_URL=http://13.209.53.103:8080 k6/scripts/shop-search.js
k6 run -e BASE_URL=http://13.209.53.103:8080 -e TEST_SHOP_ID=2 k6/scripts/review-list.js
k6 run -e BASE_URL=http://13.209.53.103:8080 -e TEST_SHOP_ID=2 k6/scripts/all-apis.js

# 통합 부하 테스트
k6 run -e BASE_URL=http://13.209.53.103:8080 k6/load-test.js
k6 run -e BASE_URL=http://13.209.53.103:8080 -e LOAD_TYPE=medium k6/load-test.js
k6 run -e BASE_URL=http://13.209.53.103:8080 -e LOAD_TYPE=heavy k6/load-test.js
k6 run -e BASE_URL=http://13.209.53.103:8080 -e LOAD_TYPE=spike k6/scripts/shop-map.js

# 동시성 테스트 (토큰 필요)
k6 run -e BASE_URL=http://13.209.53.103:8080 -e ACCESS_TOKEN=your_token k6/scripts/concurrency-test.js
```

---

## 부록: 테스트 환경

| 항목 | 값 |
|------|-----|
| EC2 인스턴스 | t3.small |
| vCPU | 2 |
| 메모리 | 2GB |
| 리전 | ap-northeast-2 (서울) |
| Java | 21 |
| Spring Boot | 3.x |
| DB | PostgreSQL (RDS) |
